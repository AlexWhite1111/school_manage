// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ----------------------------------------
// ENUM Definitions
// ----------------------------------------

enum UserRole {
  SUPER_ADMIN
  MANAGER
  TEACHER
  STUDENT
}

enum CustomerStatus {
  POTENTIAL     @map("æ½œåœ¨ç”¨æˆ·")
  INITIAL_CONTACT @map("åˆæ­¥æ²Ÿé€š")
  INTERESTED    @map("æ„å‘ç”¨æˆ·")
  TRIAL_CLASS   @map("è¯•è¯¾")
  ENROLLED      @map("æŠ¥å")
  LOST          @map("æµå¤±å®¢æˆ·")
}

enum Gender {
  MALE    @map("ç”·")
  FEMALE  @map("å¥³")
  OTHER   @map("å…¶ä»–")
}

enum TagType {
  FAMILY_JOB                 @map("family_job")
  FAMILY_INCOME              @map("family_income")
  FAMILY_EDUCATION_CONCEPT   @map("family_education_concept")
  FAMILY_FOCUS               @map("family_focus")
  FAMILY_ROLE                @map("family_role")
  CHILD_PERSONALITY          @map("child_personality")
  CHILD_ACADEMIC_LEVEL       @map("child_academic_level")
  CHILD_DISCIPLINE           @map("child_discipline")
  GROWTH_POSITIVE            @map("growth_positive")
  GROWTH_NEGATIVE            @map("growth_negative")
}

enum AttendanceStatus {
  PRESENT @map("å·²åˆ°")
  LATE    @map("è¿Ÿåˆ°")
  ABSENT  @map("è¯·å‡")
  NO_SHOW @map("æœªåˆ°")
}

enum AttendanceSlot {
  AM @map("am")
  PM @map("pm")
}

enum Grade {
  CHU_YI
  CHU_ER
  CHU_SAN
  GAO_YI
  GAO_ER
  GAO_SAN
}

enum SourceChannel {
  JIAZHANG_TUIJIAN
  PENGYOU_QINQI
  XUESHENG_SHEJIAO
  GUANGGAO_CHUANDAN
  DITUI_XUANCHUAN
  WEIXIN_GONGZHONGHAO
  DOUYIN
  QITA_MEITI
  HEZUO
  QITA
}

// ----------------------------------------
// Table Definitions
// ----------------------------------------

model User {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())  // å…¬å¼€æ ‡è¯†ç¬¦
  username      String   @unique
  passwordHash  String
  email         String?  @unique
  phone         String?
  displayName   String?  // æ˜¾ç¤ºåç§°ï¼šå­¦ç”Ÿæ˜¾ç¤ºçœŸå®å§“åï¼Œå…¶ä»–æ˜¾ç¤ºç”¨æˆ·å
  role          UserRole @default(STUDENT)  // ç”¨æˆ·è§’è‰²
  isActive      Boolean  @default(true)  // è´¦å·æ¿€æ´»çŠ¶æ€
  mustChangePassword Boolean @default(true)  // é¦–æ¬¡ç™»å½•å¿…é¡»ä¿®æ”¹å¯†ç 
  resetToken    String?  @unique  // å¯†ç é‡ç½®ä»¤ç‰Œ
  resetTokenExpiresAt DateTime?  // é‡ç½®ä»¤ç‰Œè¿‡æœŸæ—¶é—´
  lastLoginAt   DateTime?  // æœ€åç™»å½•æ—¶é—´
  linkedCustomerId Int?  @unique  // å…³è”çš„å®¢æˆ·IDï¼ˆä»…å­¦ç”Ÿç”¨æˆ·ï¼‰
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  linkedCustomer Customer? @relation("StudentUser", fields: [linkedCustomerId], references: [id], onDelete: SetNull)
  createdTags   Tag[]    @relation("TagCreator")  // ç”¨æˆ·åˆ›å»ºçš„ä¸ªäººæ ‡ç­¾
  deletedTags   Tag[]    @relation("TagDeleter")  // ç”¨æˆ·åˆ é™¤çš„æ ‡ç­¾

  @@map("users")
}

model Customer {
  id                  Int      @id @default(autoincrement())
  uuid                String   @unique @default(uuid())  // å…¬å¼€æ ‡è¯†ç¬¦  
  publicId            String   @unique  // å­¦å·ï¼šæ ¼å¼ä¸º202501123456ï¼ˆå¹´æœˆ+6ä½éšæœºæ•°ï¼‰
  name                String
  gender              Gender?
  birthDate           DateTime? @db.Date
  school              String?
  grade               Grade?
  address             String?
  sourceChannel       SourceChannel?
  firstContactDate    DateTime? @db.Date
  status              CustomerStatus @default(POTENTIAL)
  nextFollowUpDate    DateTime? @db.Date
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime? @updatedAt @map("updated_at")

  parents             Parent[]
  communicationLogs   CommunicationLog[]
  tags                CustomerTag[]
  enrollments         ClassEnrollment[] @relation("StudentEnrollments")
  financialOrders     FinancialOrder[]
  studentUser         User?    @relation("StudentUser")  // å…³è”çš„å­¦ç”Ÿè´¦å·

  // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ ç´¢å¼•
  @@index([status])
  @@index([name])
  @@index([school])
  @@index([createdAt])
  @@index([status, createdAt])
  @@index([uuid])
  @@index([publicId])  // æ–°å¢publicIdç´¢å¼•
  @@map("customers")
}

model Parent {
  id            Int      @id @default(autoincrement())
  name          String
  relationship  String?
  phone         String?
  wechatId      String?
  
  customer      Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId    Int      @map("customer_id")

  // ğŸš€ æ€§èƒ½ä¼˜åŒ–ï¼šæ·»åŠ ç´¢å¼•æ”¯æŒå®¶é•¿æœç´¢
  @@index([name])
  @@index([phone])
  @@index([customerId])
  @@map("parents")
}

model CommunicationLog {
  id          Int      @id @default(autoincrement())
  content     String   @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId  Int      @map("customer_id")

  @@map("communication_logs")
}

model Tag {
  id            Int      @id @default(autoincrement())
  text          String
  type          TagType
  isPredefined  Boolean  @default(true)
  isPersonal    Boolean  @default(false)  // æ–°å¢ï¼šæ˜¯å¦ä¸ºä¸ªäººè‡ªå®šä¹‰æ ‡ç­¾
  createdById   Int?     @map("created_by_id")  // æ–°å¢ï¼šåˆ›å»ºè€…IDï¼ˆä»…ä¸ªäººæ ‡ç­¾éœ€è¦ï¼‰
  usageCount    Int      @default(0)      // æ–°å¢ï¼šä½¿ç”¨æ¬¡æ•°ç»Ÿè®¡
  deletedAt     DateTime? @map("deleted_at")  // æ–°å¢ï¼šè½¯åˆ é™¤æ—¶é—´æˆ³
  deletedById   Int?     @map("deleted_by_id")  // æ–°å¢ï¼šåˆ é™¤æ“ä½œè€…ID

  customers     CustomerTag[]
  growthLogs    GrowthLog[]
  creator       User?    @relation("TagCreator", fields: [createdById], references: [id], onDelete: SetNull)  // æ–°å¢ï¼šåˆ›å»ºè€…å…³è”
  deletedBy     User?    @relation("TagDeleter", fields: [deletedById], references: [id], onDelete: SetNull)  // æ–°å¢ï¼šåˆ é™¤è€…å…³è”

  @@unique([text, type])
  @@index([deletedAt])  // æ·»åŠ ç´¢å¼•ä»¥ä¼˜åŒ–è½¯åˆ é™¤æŸ¥è¯¢
  @@map("tags")
}

model CustomerTag {
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId  Int      @map("customer_id")
  tag         Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId       Int      @map("tag_id")

  @@id([customerId, tagId])
  @@map("customer_tags")
}

model Class {
  id            Int      @id @default(autoincrement())
  name          String   @unique
  enrollments   ClassEnrollment[]

  @@map("classes")
}

model ClassEnrollment {
  id              Int      @id @default(autoincrement())
  enrollmentDate  DateTime? @default(now()) @db.Date

  class           Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  classId         Int      @map("class_id")
  
  student         Customer @relation("StudentEnrollments", fields: [studentId], references: [id], onDelete: Cascade)
  studentId       Int      @map("student_id")

  growthLogs        GrowthLog[]
  attendanceRecords AttendanceRecord[]

  @@unique([classId, studentId])
  @@map("class_enrollments")
}

model GrowthLog {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now()) @map("created_at")

  enrollment    ClassEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enrollmentId  Int             @map("enrollment_id")
  
  tag           Tag             @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tagId         Int             @map("tag_id")

  @@map("growth_logs")
}

model AttendanceRecord {
  id          Int      @id @default(autoincrement())
  recordDate  DateTime @db.Date
  timeSlot    AttendanceSlot
  status      AttendanceStatus
  createdAt   DateTime @default(now()) @map("created_at")

  enrollment    ClassEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  enrollmentId  Int             @map("enrollment_id")

  @@unique([enrollmentId, recordDate, timeSlot])
  @@map("attendance_records")
}

model FinancialOrder {
  id            Int      @id @default(autoincrement())
  name          String
  totalDue      Decimal  @db.Decimal(10, 2)
  coursePeriodStart DateTime? @db.Date
  coursePeriodEnd   DateTime? @db.Date
  dueDate       DateTime? @db.Date
  createdAt     DateTime @default(now()) @map("created_at")

  student       Customer @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId     Int      @map("student_id")

  payments      Payment[]

  @@map("financial_orders")
}

model Payment {
  id            Int      @id @default(autoincrement())
  amount        Decimal  @db.Decimal(10, 2)
  paymentDate   DateTime @db.Date
  notes         String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")

  order         FinancialOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId       Int            @map("order_id")

  @@map("payments")
} 