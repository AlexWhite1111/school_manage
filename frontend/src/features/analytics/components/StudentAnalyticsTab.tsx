import React, { useState, useEffect } from 'react';
import { 
  Row, 
  Col, 
  Card, 
  Select, 
  Alert, 
  Spin, 
  Empty,
  Typography,
  Tag,
  Statistic,
  Space,
  Divider,
  Progress,
  List,
  Avatar,
  Tooltip
} from 'antd';
import { Line } from '@ant-design/charts';
import { 
  LineChartOutlined,
  TagsOutlined,
  CalendarOutlined,
  UserOutlined,
  TrophyOutlined,
  ClockCircleOutlined,
  CheckCircleOutlined,
  ExclamationCircleOutlined,
  RiseOutlined,
  FallOutlined
} from '@ant-design/icons';
import { useThemeStore } from '@/stores/themeStore';
import { useResponsive } from '@/hooks/useResponsive';
import { 
  getStudentGrowthAnalytics,
  getStudentsForAnalytics 
} from '@/api/analyticsApi';
import type { 
  AnalyticsTimeRangeParams,
  StudentGrowthAnalytics 
} from '@/types/api';

const { Title, Text } = Typography;
const { Option } = Select;

interface StudentAnalyticsTabProps {
  timeParams: AnalyticsTimeRangeParams;
  refreshKey: number;
}

const StudentAnalyticsTab: React.FC<StudentAnalyticsTabProps> = ({
  timeParams,
  refreshKey
}) => {
  const { theme } = useThemeStore();
  const { isMobile } = useResponsive();
  const [loading, setLoading] = useState(false);
  const [studentsLoading, setStudentsLoading] = useState(false);
  const [selectedStudentId, setSelectedStudentId] = useState<number | null>(null);
  const [students, setStudents] = useState<{ id: number; name: string; classNames: string[] }[]>([]);
  const [growthData, setGrowthData] = useState<StudentGrowthAnalytics | null>(null);
  const [error, setError] = useState<string | null>(null);

  // ===============================
  // ‰∏ªÈ¢òÈÄÇÈÖçÁöÑÊ†∑ÂºèÈÖçÁΩÆ
  // ===============================

  const themeStyles = {
    cardBackground: theme === 'dark' ? '#141414' : '#ffffff',
    borderColor: theme === 'dark' ? '#303030' : '#e8e8e8',
    textPrimary: theme === 'dark' ? 'rgba(255, 255, 255, 0.85)' : 'rgba(0, 0, 0, 0.85)',
    textSecondary: theme === 'dark' ? 'rgba(255, 255, 255, 0.65)' : 'rgba(0, 0, 0, 0.65)',
    successColor: theme === 'dark' ? '#52c41a' : '#389e0d',
    warningColor: theme === 'dark' ? '#faad14' : '#d48806',
    errorColor: theme === 'dark' ? '#ff4d4f' : '#cf1322',
    primaryColor: theme === 'dark' ? '#1890ff' : '#1890ff',
    positiveColor: theme === 'dark' ? '#52c41a' : '#52c41a',
    negativeColor: theme === 'dark' ? '#ff7875' : '#ff4d4f'
  };

  // ===============================
  // Âä†ËΩΩÂ≠¶ÁîüÂàóË°®
  // ===============================

  const loadStudents = async () => {
    setStudentsLoading(true);
    try {
      const studentsData = await getStudentsForAnalytics();
      setStudents(studentsData);
      
      // Ëá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™Â≠¶Áîü
      if (studentsData.length > 0 && !selectedStudentId) {
        setSelectedStudentId(studentsData[0].id);
      }
    } catch (err) {
      console.error('‚ùå Â≠¶ÁîüÂàóË°®Âä†ËΩΩÂ§±Ë¥•:', err);
      setError('Â≠¶ÁîüÂàóË°®Âä†ËΩΩÂ§±Ë¥•');
    } finally {
      setStudentsLoading(false);
    }
  };

  // ===============================
  // Âä†ËΩΩÂ≠¶ÁîüÊàêÈïøÊï∞ÊçÆ
  // ===============================

  const loadGrowthData = async () => {
    if (!selectedStudentId) return;
    
    setLoading(true);
    setError(null);
    
    try {
      console.log('üîÑ Âä†ËΩΩÂ≠¶ÁîüÊàêÈïøÊï∞ÊçÆ...', { studentId: selectedStudentId, timeParams });
      
      const growthResult = await getStudentGrowthAnalytics(selectedStudentId, timeParams);
      console.log('üìä Â≠¶ÁîüÊàêÈïøAPIËøîÂõûÊï∞ÊçÆ:', growthResult);
      setGrowthData(growthResult);
      
      console.log('‚úÖ Â≠¶ÁîüÊàêÈïøÊï∞ÊçÆÂä†ËΩΩÊàêÂäü');
    } catch (err) {
      console.error('‚ùå Â≠¶ÁîüÊàêÈïøÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', err);
      setError(err instanceof Error ? err.message : 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    loadStudents();
  }, []);

  useEffect(() => {
    console.log('üîÑ StudentAnalyticsTab useEffect triggered:', { selectedStudentId, timeParams, refreshKey });
    if (selectedStudentId) {
      loadGrowthData();
    }
  }, [selectedStudentId, timeParams, refreshKey]);

  // ===============================
  // Ê∏≤ÊüìÊàêÈïøË∂ãÂäøÂõæ
  // ===============================

  const renderGrowthTrendChart = () => {
    if (!growthData?.growthTrend || growthData.growthTrend.length === 0) {
      return (
        <Empty 
          description="ÊöÇÊó†ÊàêÈïøË∂ãÂäøÊï∞ÊçÆ" 
          image={Empty.PRESENTED_IMAGE_SIMPLE}
        />
      );
    }

    // ÂáÜÂ§áÂõæË°®Êï∞ÊçÆ
    const chartData = growthData.growthTrend.flatMap(item => [
      {
        date: item.date,
        count: item.positiveCount || 0,
        type: 'Ê≠£Èù¢Ê†áÁ≠æ',
      },
      {
        date: item.date,
        count: item.negativeCount || 0,
        type: 'ÈúÄË¶ÅÊîπËøõ',
      },
    ]);

    const config: any = {
      data: chartData,
      xField: 'date',
      yField: 'count',
      seriesField: 'type',
      smooth: true,
      animation: {
        appear: {
          animation: 'path-in',
          duration: 1000,
        },
      },
      color: ['#52c41a', '#ff7875'], // Êõ¥ÊòéÁ°ÆÁöÑÈ¢úËâ≤ÂØπÊØî
      point: {
        size: isMobile ? 3 : 4,
        shape: 'circle',
      },
      lineStyle: {
        lineWidth: isMobile ? 2 : 3,
      },
      tooltip: {
        formatter: (datum: any) => ({
          name: datum.type,
          value: `${datum.count} Ê¨°`,
        }),
        showCrosshairs: true,
        shared: true,
      },
      legend: {
        position: isMobile ? 'bottom' : 'top',
        itemSpacing: isMobile ? 16 : 24,
      },
      xAxis: {
        type: 'time',
        mask: 'MM-DD',
        tickCount: isMobile ? 4 : 6,
        label: {
          style: {
            fontSize: isMobile ? 10 : 12,
          },
        },
      },
      yAxis: {
        min: 0,
        tickCount: isMobile ? 4 : 5,
        label: {
          style: {
            fontSize: isMobile ? 10 : 12,
          },
        },
        grid: {
          line: {
            style: {
              stroke: theme === 'dark' ? '#434343' : '#f0f0f0',
              lineWidth: 1,
              lineDash: [4, 5],
            },
          },
        },
      },
      theme,
      autoFit: true,
      padding: isMobile ? [20, 20, 40, 40] : [20, 20, 40, 60],
    };

    return (
      <div style={{ height: isMobile ? '280px' : '350px', width: '100%' }}>
        <Line {...config} />
      </div>
    );
  };

  // ===============================
  // Ê∏≤ÊüìÈ´òÈ¢ëÊ†áÁ≠æ
  // ===============================

  const renderTopTags = () => {
    if (!growthData?.topTags) return null;

    return (
      <Row gutter={[16, 16]}>
        {/* ÁßØÊûÅÊ†áÁ≠æ */}
        <Col span={12}>
          <Card
            size="small"
            title={
              <Space>
                <RiseOutlined style={{ color: themeStyles.positiveColor }} />
                <Text style={{ color: themeStyles.textPrimary }}>
                  È´òÈ¢ëÁßØÊûÅÊ†áÁ≠æ
                </Text>
              </Space>
            }
            bordered={false}
            style={{ 
              background: themeStyles.cardBackground,
              borderRadius: '8px'
            }}
          >
            <List
              size="small"
              dataSource={growthData.topTags.positive}
              renderItem={(tag, index) => (
                <List.Item style={{ padding: '8px 0' }}>
                  <List.Item.Meta
                    avatar={
                      <Avatar 
                        size="small" 
                        style={{ 
                          backgroundColor: themeStyles.positiveColor,
                          color: 'white'
                        }}
                      >
                        {index + 1}
                      </Avatar>
                    }
                    title={
                      <Text style={{ color: themeStyles.textPrimary }}>
                        {tag.tagText}
                      </Text>
                    }
                    description={
                      <Tag color="green">
                        {tag.count} Ê¨°
                      </Tag>
                    }
                  />
                </List.Item>
              )}
            />
            {(!growthData.topTags.positive || growthData.topTags.positive.length === 0) && (
              <div style={{ padding: '20px', textAlign: 'center' }}>
                <Alert
                  message="ÊöÇÊó†Êï∞ÊçÆ"
                  description="ÂΩìÂâçÊó∂Èó¥ÊÆµÂÜÖÊ≤°ÊúâÁßØÊûÅÊ†áÁ≠æËÆ∞ÂΩï"
                  type="info"
                  showIcon
                />
              </div>
            )}
          </Card>
        </Col>

        {/* Ê∂àÊûÅÊ†áÁ≠æ */}
        <Col span={12}>
          <Card
            size="small"
            title={
              <Space>
                <FallOutlined style={{ color: themeStyles.negativeColor }} />
                <Text style={{ color: themeStyles.textPrimary }}>
                  È´òÈ¢ëÊ∂àÊûÅÊ†áÁ≠æ
                </Text>
              </Space>
            }
            bordered={false}
            style={{ 
              background: themeStyles.cardBackground,
              borderRadius: '8px'
            }}
          >
            <List
              size="small"
              dataSource={growthData.topTags.negative}
              renderItem={(tag, index) => (
                <List.Item style={{ padding: '8px 0' }}>
                  <List.Item.Meta
                    avatar={
                      <Avatar 
                        size="small" 
                        style={{ 
                          backgroundColor: themeStyles.negativeColor,
                          color: 'white'
                        }}
                      >
                        {index + 1}
                      </Avatar>
                    }
                    title={
                      <Text style={{ color: themeStyles.textPrimary }}>
                        {tag.tagText}
                      </Text>
                    }
                    description={
                      <Tag color="red">
                        {tag.count} Ê¨°
                      </Tag>
                    }
                  />
                </List.Item>
              )}
            />
            {(!growthData.topTags.negative || growthData.topTags.negative.length === 0) && (
              <div style={{ padding: '20px', textAlign: 'center' }}>
                <Alert
                  message="ÊöÇÊó†Êï∞ÊçÆ"
                  description="ÂΩìÂâçÊó∂Èó¥ÊÆµÂÜÖÊ≤°ÊúâÊ∂àÊûÅÊ†áÁ≠æËÆ∞ÂΩï"
                  type="info"
                  showIcon
                />
              </div>
            )}
          </Card>
        </Col>
      </Row>
    );
  };

  // ===============================
  // Ê∏≤ÊüìËÄÉÂã§Ê¶ÇËßà
  // ===============================

  const renderAttendanceSummary = () => {
    if (!growthData?.attendanceSummary) return null;

    const { attendanceSummary } = growthData;
    
    return (
      <Row gutter={[16, 16]}>
        <Col span={6}>
          <Statistic
            title="ÊÄªÂá∫Âã§Â§©Êï∞"
            value={attendanceSummary.totalDays}
            prefix={<CalendarOutlined style={{ color: themeStyles.primaryColor }} />}
            valueStyle={{ color: themeStyles.textPrimary }}
          />
        </Col>
        <Col span={6}>
          <Statistic
            title="Âá∫Âã§Áéá"
            value={attendanceSummary.attendanceRate}
            suffix="%"
            precision={1}
            prefix={<CheckCircleOutlined style={{ color: themeStyles.successColor }} />}
            valueStyle={{ 
              color: attendanceSummary.attendanceRate >= 80 
                ? themeStyles.successColor 
                : attendanceSummary.attendanceRate >= 60 
                  ? themeStyles.warningColor 
                  : themeStyles.errorColor 
            }}
          />
        </Col>
        <Col span={6}>
          <Statistic
            title="Ê≠£Â∏∏Âá∫Âã§"
            value={attendanceSummary.presentDays}
            prefix={<CheckCircleOutlined style={{ color: themeStyles.successColor }} />}
            valueStyle={{ color: themeStyles.textPrimary }}
          />
        </Col>
        <Col span={6}>
          <Statistic
            title="Áº∫Âã§/Êú™Âà∞"
            value={attendanceSummary.absentDays + attendanceSummary.noShowDays}
            prefix={<ExclamationCircleOutlined style={{ color: themeStyles.errorColor }} />}
            valueStyle={{ color: themeStyles.textPrimary }}
          />
        </Col>
      </Row>
    );
  };

  // ===============================
  // ÈîôËØØÁä∂ÊÄÅ
  // ===============================

  if (error) {
    return (
      <Alert
        message="Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•"
        description={error}
        type="error"
        showIcon
        style={{ margin: '20px' }}
      />
    );
  }

  // ===============================
  // Ê∏≤Êüì‰∏ªË¶ÅÂÜÖÂÆπ
  // ===============================

  return (
    <div style={{ padding: '0 24px' }}>
      {/* Â≠¶ÁîüÈÄâÊã©Âô® */}
      <Card
        bordered={false}
        style={{ 
          background: themeStyles.cardBackground,
          borderRadius: '12px',
          marginBottom: '24px',
          boxShadow: theme === 'dark' 
            ? '0 2px 8px rgba(0, 0, 0, 0.3)' 
            : '0 2px 8px rgba(0, 0, 0, 0.1)'
        }}
      >
        <Row align="middle" gutter={[16, 0]}>
          <Col span={4}>
            <Text strong style={{ color: themeStyles.textPrimary }}>
              <UserOutlined style={{ marginRight: '8px', color: themeStyles.primaryColor }} />
              ÈÄâÊã©Â≠¶Áîü
            </Text>
          </Col>
          <Col span={8}>
            <Select
              placeholder="ËØ∑ÈÄâÊã©Ë¶ÅÂàÜÊûêÁöÑÂ≠¶Áîü"
              value={selectedStudentId}
              onChange={setSelectedStudentId}
              loading={studentsLoading}
              style={{ width: '100%' }}
              showSearch
              filterOption={(input, option) => {
                // ‰ΩøÁî®Â≠¶ÁîüÂêçÁß∞ËøõË°åÊêúÁ¥¢ÔºàÁ°Æ‰øùÁ±ªÂûã‰∏ÄËá¥Ôºâ
                const valueAsNumber = Number(option?.value);
                const student = students.find(s => s.id === valueAsNumber);
                return student ? student.name.toLowerCase().includes(input.toLowerCase()) : false;
              }}
            >
              {students.map(student => (
                <Option key={student.id} value={student.id}>
                  <Space>
                    <Text>{student.name}</Text>
                    <Text type="secondary" style={{ fontSize: '12px' }}>
                      ({student.classNames.join(', ')})
                    </Text>
                  </Space>
                </Option>
              ))}
            </Select>
          </Col>
          {growthData && (
            <Col span={12}>
              <Space size="large">
                <Text style={{ color: themeStyles.textSecondary }}>
                  ÂàÜÊûêÂë®ÊúüÔºö{growthData.dateRange.startDate} Ëá≥ {growthData.dateRange.endDate}
                </Text>
                <Tag color={themeStyles.primaryColor}>
                  {growthData.studentName}
                </Tag>
              </Space>
            </Col>
          )}
        </Row>
      </Card>

      {selectedStudentId && (
        <Spin spinning={loading} tip="Ê≠£Âú®Âä†ËΩΩÂ≠¶ÁîüÊàêÈïøÊï∞ÊçÆ...">
          <Row gutter={[16, 16]}>
            {/* ÊàêÈïøË∂ãÂäøÂõæ */}
            <Col span={24}>
              <Card
                title={
                  <Space>
                    <LineChartOutlined style={{ color: themeStyles.primaryColor }} />
                    <Text strong style={{ color: themeStyles.textPrimary }}>
                      ÊàêÈïøË∂ãÂäøÂàÜÊûê
                    </Text>
                  </Space>
                }
                bordered={false}
                style={{ 
                  background: themeStyles.cardBackground,
                  borderRadius: '12px',
                  marginBottom: '24px',
                  boxShadow: theme === 'dark' 
                    ? '0 2px 8px rgba(0, 0, 0, 0.3)' 
                    : '0 2px 8px rgba(0, 0, 0, 0.1)'
                }}
              >
                <div style={{ minHeight: '300px' }}>
                  {renderGrowthTrendChart()}
                </div>
              </Card>
            </Col>

            {/* È´òÈ¢ëÊ†áÁ≠æÁªüËÆ° */}
            <Col span={24}>
              <Card
                title={
                  <Space>
                    <TagsOutlined style={{ color: themeStyles.primaryColor }} />
                    <Text strong style={{ color: themeStyles.textPrimary }}>
                      È´òÈ¢ëÊàêÈïøÊ†áÁ≠æ
                    </Text>
                  </Space>
                }
                bordered={false}
                style={{ 
                  background: themeStyles.cardBackground,
                  borderRadius: '12px',
                  marginBottom: '24px',
                  boxShadow: theme === 'dark' 
                    ? '0 2px 8px rgba(0, 0, 0, 0.3)' 
                    : '0 2px 8px rgba(0, 0, 0, 0.1)'
                }}
              >
                {renderTopTags()}
              </Card>
            </Col>

            {/* ËÄÉÂã§Ê¶ÇËßà */}
            <Col span={24}>
              <Card
                title={
                  <Space>
                    <CalendarOutlined style={{ color: themeStyles.primaryColor }} />
                    <Text strong style={{ color: themeStyles.textPrimary }}>
                      ËÄÉÂã§Ê¶ÇËßà
                    </Text>
                  </Space>
                }
                bordered={false}
                style={{ 
                  background: themeStyles.cardBackground,
                  borderRadius: '12px',
                  boxShadow: theme === 'dark' 
                    ? '0 2px 8px rgba(0, 0, 0, 0.3)' 
                    : '0 2px 8px rgba(0, 0, 0, 0.1)'
                }}
              >
                {renderAttendanceSummary()}
              </Card>
            </Col>
          </Row>
        </Spin>
      )}

      {!selectedStudentId && !loading && (
        <Card
          bordered={false}
          style={{ 
            background: themeStyles.cardBackground,
            borderRadius: '12px',
            textAlign: 'center',
            padding: '60px 20px'
          }}
        >
          <Empty
            description={
              <Text style={{ color: themeStyles.textSecondary }}>
                ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Â≠¶ÁîüËøõË°åÊàêÈïøÂàÜÊûê
              </Text>
            }
            image={Empty.PRESENTED_IMAGE_SIMPLE}
          />
        </Card>
      )}
    </div>
  );
};

export default StudentAnalyticsTab; 