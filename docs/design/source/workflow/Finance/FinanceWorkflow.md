# 极简财务中心 (Simple Finance) 详细交互流程

本文档详细描述了"极简财务中心"模块的订单管理主页、学生个人财务详情页的元素、交互流程及系统反馈。

## 1. Feature 3.1: 订单管理主页

这是财务中心的入口页面，提供所有已报名学生的财务状况概览。

### 1.1 页面核心元素

*   **页面标题:** "财务中心 - 订单管理"
*   **页面导航:** 
    *   面包屑导航：首页 > 财务中心
    *   返回仪表盘的快速链接
*   **顶部工具栏:** 
    *   左侧：筛选选项（缴费状态、欠款情况等）
    *   右侧：**"导出财务数据 (CSV)"** 按钮和搜索框
*   **学生财务列表:** 页面主体是一个表格，每一行代表一个已报名的学生。**数据通过调用 `GET /finance/student-summaries` API 获取**。列表包含以下精心设计的列：
    *   `学生姓名`: 学生的姓名，点击可跳转到学生详情页
    *   `近期出勤 (最近30天)`: **(关联字段)** 一个概览，例如: `到:10 迟:1 假:0 未:0`，**数据来源需要关联考勤API `GET /classes/:id/students`**，让管理者能结合出勤看财务
    *   `总应收`: 该学生所有订单的"应收总额"之和
    *   `总实收`: 该学生所有"收款记录"的金额之和
    *   `总欠款`: `总应收` - `总实收` 的计算结果（后端计算）
    *   `缴费状态`: **(聚合状态字段)** 根据该生名下所有订单的状况，显示为 `全部结清` / `部分结清` / `均未支付`，并用颜色区分（绿/橙/红）
    *   `最后更新`: 显示最后一次财务记录的更新时间
    *   `操作`: 一个"查看详情"按钮

### 1.2 交互流程

1.  **进入页面**
    *   **用户行为:** 用户通过主导航或仪表盘点击进入"财务中心"。
    *   **系统反馈:**
        *   **API调用:** 页面加载时自动调用 `GET /finance/student-summaries` API
        *   页面显示加载动画或骨架屏
        *   数据加载完成后展示学生财务列表
        *   **边缘情况 (加载失败):** 显示错误提示和重试按钮
        *   **边缘情况 (无学生):** 若系统中没有"已报名"的学生，则显示空状态提示："暂无已报名的学生，请先在CRM模块中将客户转化为报名学员。"并提供跳转到CRM的按钮

2.  **筛选和搜索**
    *   **用户行为:** 用户使用顶部的筛选器或搜索框。
    *   **系统反馈:**
        *   实时调用 `GET /finance/student-summaries` API，附带筛选参数
        *   列表数据实时更新，显示符合条件的学生
        *   如果无匹配结果，显示"未找到符合条件的学生"提示

3.  **查看学生财务详情**
    *   **用户行为:** 用户点击某学生行末尾的"查看详情"按钮或学生姓名。
    *   **系统反馈:** 页面跳转至该学生的个人财务详情页 (`/finance/students/:id`)。

4.  **导出财务数据**
    *   **用户行为:** 用户点击"导出财务数据 (CSV)"按钮。
    *   **系统反馈:**
        *   **API调用:** 调用 `GET /export/finance` API，附带当前筛选条件
        *   按钮显示加载状态，禁用交互
        *   成功时自动下载CSV文件，失败时显示错误提示

## 2. 学生个人财务详情页

此页面集中展示和管理单个学生的所有收费订单和收款记录。

### 2.1 页面核心元素

*   **页面头部:**
    *   **页面标题:** "财务详情 - [学生姓名]"
    *   **面包屑导航:** 首页 > 财务中心 > 学生详情
    *   **学生基础信息卡片:** 显示学生姓名、班级、联系方式等基本信息
*   **财务概览卡片:**
    *   显示该学生的财务汇总信息（总应收、总实收、总欠款、缴费状态）
*   **操作区域:** 页面右上角有一个 **"+ 新建收费订单"** 按钮
*   **订单列表:** 页面主体是该学生的订单列表，**数据通过调用 `GET /finance/students/:id/details` API 获取**。每个订单以卡片形式展示，包含：
    *   **订单信息:**
        *   **订单名称:** 例如"2024年秋季班学费"
        *   `应收总额`: 该笔订单的总金额
        *   `已收金额`: 该订单下所有收款记录之和
        *   `剩余未付`: `应收总额` - `已收金额`（后端计算）
        *   `结账日期`: 这笔订单的付款截止日期
        *   `课程周期`: 相关的课程时间段
        *   `订单状态`: 颜色鲜明的状态标签 (`未支付`, `部分支付`, `已付清`)
        *   `创建时间`: 订单创建的时间
    *   **操作按钮:**
        *   `+ 添加收款`: 用于为该订单添加一笔回款记录
        *   `编辑订单`: 修改订单信息（仅在未完全支付时可用）
        *   `删除订单`: 删除订单（仅在无收款记录时可用）
        *   展开/收起按钮：用于显示/隐藏收款记录详情
    *   **收款记录详情 (默认收起):**
        *   展开后，显示一个表格，包含该订单下的每一笔收款记录
        *   每条记录包含 `收款日期`、`金额`、`备注` 和 `操作`（编辑/删除）

### 2.2 交互流程

1.  **页面初始化**
    *   **用户行为:** 用户从订单管理主页点击学生进入详情页。
    *   **系统反馈:**
        *   **API调用:** 调用 `GET /finance/students/:id/details` API 获取学生详细财务信息
        *   页面显示加载状态
        *   数据加载完成后展示学生的所有订单和收款记录
        *   **错误处理:** 如果学生ID不存在，显示404页面；如果API调用失败，显示错误提示和重试按钮

2.  **新建收费订单**
    *   **用户行为:** 用户点击页面右上角的"+ 新建收费订单"按钮。
    *   **系统反馈:**
        *   弹出一个 **"新建收费订单"** 模态窗口，包含以下输入字段：
            *   `订单名称` (必填, 文本输入)
            *   `应收总额` (必填, 数字输入，支持小数点)
            *   `课程周期` (可选, 日期范围选择器)
            *   `结账日期` (可选, 日期选择器，默认为30天后)
            *   `备注` (可选, 多行文本)
        *   **前端验证:** 必填项检查、金额格式验证、日期有效性验证
        *   **API调用:** 用户填写完毕后点击"确认创建"，调用 `POST /finance/orders` API
        *   **响应处理:**
            *   成功：窗口关闭，页面刷新，新订单出现在列表最上方，显示"订单创建成功"提示
            *   失败：显示具体错误信息，保持窗口打开允许用户修改

3.  **编辑订单信息**
    *   **用户行为:** 用户点击订单卡片上的"编辑订单"按钮。
    *   **系统反馈:**
        *   弹出编辑订单的模态窗口，预填充当前订单信息
        *   **API调用:** 用户确认修改后调用 `PUT /finance/orders/:orderId` API
        *   成功后更新页面数据，显示"订单更新成功"提示

4.  **删除订单**
    *   **用户行为:** 用户点击订单卡片上的"删除订单"按钮。
    *   **系统反馈:**
        *   弹出确认对话框："确定要删除此订单吗？此操作不可撤销。"
        *   **API调用:** 用户确认后调用 `DELETE /finance/orders/:orderId` API
        *   成功后从列表中移除该订单，显示"订单删除成功"提示

5.  **添加收款记录**
    *   **用户行为:** 用户在某个订单卡片上点击"+ 添加收款"按钮。
    *   **系统反馈:**
        *   弹出一个 **"添加收款"** 模态窗口，包含：
            *   `收款日期` (必填, 日期选择器，默认为今天)
            *   `金额` (必填, 数字输入，最大值不能超过剩余未付金额)
            *   `收款方式` (可选, 下拉选择：现金/银行转账/支付宝/微信等)
            *   `备注` (可选, 文本输入)
        *   **前端验证:** 金额不能超过剩余未付金额，不能为负数
        *   **API调用:** 用户填写后点击"确认添加"，调用 `POST /finance/orders/:orderId/payments` API
        *   **响应处理:**
            *   成功：窗口关闭，该订单卡片上的 **`剩余未付` 金额** 和 **`订单状态` 标签** 立即更新，财务概览卡片数据同步更新，显示"收款记录添加成功"提示
            *   失败：显示错误信息，保持窗口打开

6.  **查看和管理收款记录**
    *   **用户行为:** 用户点击订单卡片上的"展开"按钮。
    *   **系统反馈:** 
        *   卡片向下展开，平滑地显示出该订单的所有收款记录表格
        *   再次点击则收起
        *   每条收款记录旁有"编辑"和"删除"按钮
    
    *   **编辑收款记录:**
        *   **API调用:** `PUT /finance/payments/:paymentId` API
        *   更新成功后刷新相关数据
    
    *   **删除收款记录:**
        *   弹出确认对话框
        *   **API调用:** `DELETE /finance/payments/:paymentId` API
        *   成功后更新订单状态和金额信息

### 2.3 实时数据更新与同步

*   **本地状态管理:**
    *   订单列表和收款记录的增删改操作成功后，立即更新本地状态
    *   避免不必要的页面重新加载，提升用户体验

*   **数据一致性:**
    *   每次收款操作后，自动重新计算订单状态和剩余金额
    *   财务概览卡片的数据与订单列表保持同步

*   **跨页面同步:**
    *   从详情页返回列表页时，确保列表数据反映最新的修改
    *   可通过页面刷新或本地存储机制实现

## 3. 边缘情况处理

*   **数据校验:**
    *   **前端校验:** 在创建订单或添加收款的表单中，对必填项、数字格式、日期有效性进行实时校验
    *   **后端校验:** API层面进行数据完整性和业务逻辑校验
    *   校验失败时，在对应输入框下方显示具体错误信息，并阻止提交

*   **网络异常处理:**
    *   **加载状态:** 任何API调用都会显示相应的加载状态
    *   **错误提示:** 网络错误、服务器错误、业务错误都有相应的提示信息
    *   **重试机制:** 对于临时性错误，提供重试按钮
    *   **操作防抖:** 防止用户连续点击提交按钮造成重复操作

*   **权限与安全:**
    *   确保用户只能查看和操作自己权限范围内的学生财务信息
    *   敏感操作（如删除订单）需要二次确认

*   **数据完整性:**
    *   当订单有收款记录时，不允许删除订单
    *   收款金额不能超过订单的剩余未付金额
    *   删除收款记录时，自动更新订单状态

*   **性能优化:**
    *   对于学生较多的情况，列表页面支持分页加载
    *   使用适当的缓存策略减少不必要的API调用
    *   订单详情页面的数据更新采用局部刷新而非整页重载 