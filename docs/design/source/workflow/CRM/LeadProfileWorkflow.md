# 客户档案 (Lead Profile) 详细交互流程

本文档详细描述了“客户档案”页面的所有元素、交互流程，并与“客户看板”功能紧密衔接。页面默认即为编辑模式，以实现最高效的信息录入和修改。

## 1. 流程入口 (Entry Point)

*   **用户行为:** 在“客户看板”界面的客户列表中，用户点击任意客户所在行末尾的“查看/编辑”按钮。
*   **系统反馈:** 页面跳转至该客户的专属“客户档案”页面。**通过 `GET /customers/:id` API 获取并填充客户的完整数据**。页面加载完成后，所有字段均处于可编辑状态。

## 2. 页面核心元素

*   **页面标题:** 清晰地显示 **“客户档案 - [客户姓名]”**。
*   **全局操作按钮:**
    *   在页面底部或右下角，始终悬浮一个绿色的 **“确认保存”** 按钮。**此按钮调用 `PUT /customers/:id` API**。
    *   页面左上角提供一个 **“返回”** 按钮，用于返回“客户看板”界面。
*   **页面布局:** 整体页面从上至下分为三个主要区域：
    1.  **基础信息区 (Basic Information):** 包含所有必填和选填的客户基础资料。
    2.  **家庭画像区 (Family Portrait):** 用于给客户打上多维度、可自定义的标签。
    3.  **沟通纪要区 (Communication Log):** 记录与客户的历次沟通内容。
*   **页面页脚信息 (Footer Info):**
    *   在页面所有可编辑内容的下方，但在悬浮的“确认保存”按钮之上，会显示一条信息：
    *   `最新编辑时间: [YYYY-MM-DD HH:MM:SS]` (此为只读信息，来自客户数据的 `updatedAt` 字段，在每次成功保存后自动更新)

## 3. 交互流程详述

### 3.1 编辑基础信息

*   **用户行为:** 用户直接在表单的输入框、下拉菜单、日期选择器中进行修改。
*   **系统反馈:**
    *   所有在需求文档中建议的必填项，其字段名前都应有红色的星号 `*` 作为标记。
    *   **字段完全参照 `POST /customers` API 请求体:**
        *   **1. 孩子信息**
            *   `* 孩子姓名`: `name`
            *   `* 性别`: `gender` (MALE / FEMALE)
            *   `* 出生年月`: `birthDate`
            *   `* 学校`: `school`
            *   `* 年级`: `grade`
        *   **2. 家长信息 (对应 `parents` 数组)**
            *   `* 家长姓名`: `parents[n].name`
            *   `* 与孩子关系`: `parents[n].relationship`
            *   `* 家长联系方式`: `parents[n].phone`
            *   `家长微信号`: `parents[n].wechatId` (选填)
            *   提供 `+ 添加` 按钮，用于动态增删家长信息。
        *   **3. 联系与来源信息**
            *   `* 家庭住址或所在区域`: `address`
            *   `* 来源渠道`: `sourceChannel`
            *   `* 首次接触日期`: `firstContactDate`
        *   **4. 客户状态**
            *   `* 当前客户状态`: `status`。下拉菜单选项需映射到 API `CustomerStatus` 枚举: `POTENTIAL`, `INITIAL_CONTACT`, `INTERESTED`, `TRIAL_CLASS`, `ENROLLED`, `LOST`。
        *   **5. 跟进提醒 (Follow-up Reminder)**
            *   `下次跟进日期`: `nextFollowUpDate` (选填)。
            *   **说明:** 此处设置的日期到期后，该客户将出现在主仪表盘的“待办提醒”列表中。

### 3.2 编辑“家庭画像”标签

*   **用户行为:** 在每个画像板块下，用户可以自由勾选一个或多个预设的标签，也可以在“自定义”输入框中键入新标签。
*   **系统反馈:**
    *   **加载时:** 页面 **调用 `GET /tags` API** 获取所有可用的标签列表并展示。
    *   **自定义标签 (采用乐观更新策略):**
        1.  **即时UI反馈:** 用户在自定义输入框中输入新标签文本（如“艺术特长”）后按 `Enter`。前端**立即**将一个临时的标签对象添加到本地状态中，并让新标签出现在列表中且被自动选中。此过程对用户来说是瞬时完成的，无感知延迟。
        2.  **后台静默同步:** 与此同时，前端**在后台调用 `POST /tags` API**，将新标签的文本和类型发送给服务器进行真正的创建。
        3.  **状态校准:** API调用成功后会返回包含真实 `tagId` 的标签对象。前端收到后，用这个真实对象**替换**掉本地的临时对象，完成数据同步。这个过程用户同样无感知。
    *   **保存时:** 当用户点击主“确认保存”按钮时，前端收集所有被选中的、**真实的**标签ID（确保是一个纯数字数组），并通过 **`PUT /customers/:id` API** 的 `tags` 字段进行保存。
    *   **所有预设标签均完整展示，无需用户手动添加：**
        1.  **家长职业与工作情况**: `全职妈妈`, `双职工家庭`, `自由职业`, `企业高管`, `公务员`, `[+] 自定义输入`
        2.  **家庭经济与收入层次**: `中等收入`, `高收入`, `经济压力较大`, `[+] 自定义输入`
        3.  **家庭教育观念**: `应试导向`, `素质教育`, `兴趣优先`, `重视全面发展`, `[+] 自定义输入`
        4.  **家庭关注重点**: `成绩提升`, `习惯养成`, `心理健康`, `特长发展`, `[+] 自定义输入`
        5.  **父母角色与强势程度**: `母亲主导`, `父亲主导`, `父母平衡`, `隔代抚养`, `[+] 自定义输入`
        6.  **孩子性格特征**: `外向`, `内向`, `敏感`, `独立`, `依赖`, `[+] 自定义输入`
        7.  **孩子学习成绩水平**: `优异`, `中等`, `需提升`, `偏科`, `[+] 自定义输入`
        8.  **孩子服从与自律程度**: `自律性强`, `需督促`, `易分心`, `主动性高`, `[+] 自定义输入`

### 3.3 管理“沟通纪要” (即时保存)

此区域的操作是**即时生效**的，不依赖于页面底部的全局“确认保存”按钮，以确保沟通记录不会因忘记保存而丢失。

*   **用户行为与系统反馈:**
    1.  **查看纪要:**
        *   纪要列表严格按照 **“最后编辑时间” 倒序排列**，最新的记录永远在最上方。
        *   每条纪要都清晰地显示其 **内容**、**最后编辑时间**，以及“编辑”和“删除”图标按钮。
    2.  **创建新纪要:**
        *   用户点击区域顶部的 **“+ 添加新纪要”** 按钮。
        *   列表最上方出现一个空白的多行文本输入框，旁边有“保存”和“取消”按钮，光标自动聚焦于输入框。
        *   用户输入内容后点击“保存”，前端立即 **调用 `POST /customers/:id/logs` API**。
        *   成功后，输入框变为只读的纪要条目，并显示最新的编辑时间，“保存”/“取消”按钮变为“编辑”/“删除”按钮。
    3.  **编辑已有纪要:**
        *   用户点击某条纪要旁的“编辑”按钮。
        *   该条纪要变为可编辑状态，同时出现“保存”和“取消”按钮。
        *   用户修改后点击“保存”，前端立即 **调用 `PUT /customers/logs/:logId` API**。
        *   成功后，该条目更新内容和编辑时间，并恢复为只读状态。
    4.  **删除已有纪要:**
        *   用户点击某条纪要旁的“删除”按钮。
        *   系统弹出确认对话框：“您确定要删除这条纪要吗？”
        *   确认后，前端立即 **调用 `DELETE /customers/logs/:logId` API**。
        *   成功后，该条纪要从列表中被移除。

### 3.4 保存基础信息与家庭画像

*   **用户行为:** 用户在完成 **基础信息** 和 **家庭画像** 的修改后，点击页面底部的 **“确认保存”** 按钮。
*   **系统反馈:**
    1.  **前端校验:** 系统会首先检查所有带 `*` 的必填项是否已填写。若有遗漏，页面会自动滚动到第一个未填写的字段，高亮其输入框，并显示提示：“请填写所有必填信息。”
    2.  **提交数据:**
        *   校验通过后，“确认保存”按钮会变为 **禁用** 状态，并显示加载动画，以防重复提交。
        *   系统将 **除沟通纪要外** 的所有表单数据打包，**调用 `PUT /customers/:id` API**。
        *   **成功:** 加载动画消失，按钮恢复可用。页面顶部滑出绿色成功提示：“客户 **[客户姓名]** 的信息已成功保存！”。页面停留在当前，所有数据为最新状态，同时页面底部的“最新编辑时间”会刷新为当前保存成功的时间。
        *   **失败 (网络或服务器错误):** 按钮恢复可用，并弹出红色错误提示：“信息保存失败，请检查网络后重试。”

## 4. 边缘情况处理

*   **离开未保存的页面:**
    *   **用户行为:** 用户在修改了信息但未保存的情况下，点击“返回”按钮或尝试关闭页面。
    *   **系统反馈:** 浏览器弹出标准确认框：“您有未保存的更改，确定要离开吗？”，由用户选择“离开”或“留下”。
*   **数据冲突:** （多人协作场景，本次可简化）如果其他用户同时编辑，保存时应提示冲突并让用户选择如何处理。为简化，本次可假定为单人使用。 